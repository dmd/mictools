#!/cm/shared/apps/miniforge3/envs/iris/bin/python

import argparse
import tempfile
import os
import subprocess
import sys
import yaml

def main():
    parser = argparse.ArgumentParser(
        description="""Convert DICOM files to NIfTI format using iris-fmriprep.
This is equivalent to running 'iris-fmriprep studydir' with a YAML config containing only 'run: nifti'."""
    )
    parser.add_argument(
        "studydir", 
        help="Path to study directory containing scans/ folder with DICOM files."
    )
    args = parser.parse_args()

    # Create a temporary YAML config file with just "run: nifti"
    config_content = {"run": "nifti"}
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.yaml', delete=False) as temp_config:
        yaml.dump(config_content, temp_config)
        temp_config_path = temp_config.name

    try:
        # Find the iris-fmriprep script in the same directory as this script
        script_dir = os.path.dirname(os.path.abspath(__file__))
        iris_fmriprep_path = os.path.join(script_dir, "iris-fmriprep")
        
        if not os.path.exists(iris_fmriprep_path):
            print(f"Error: iris-fmriprep not found at {iris_fmriprep_path}", file=sys.stderr)
            sys.exit(1)

        # Build the iris-fmriprep command
        cmd = [
            iris_fmriprep_path,
            "--config", temp_config_path,
            "--subject", "dummy",  # Required but not used for nifti conversion
            args.studydir
        ]
        
        # Execute iris-fmriprep
        result = subprocess.run(cmd, capture_output=False)
        sys.exit(result.returncode)
        
    finally:
        # Clean up temporary config file
        try:
            os.unlink(temp_config_path)
        except OSError:
            pass

if __name__ == "__main__":
    main()
